<head>
  <style>
body {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 4px 16px 16px;
    gap: 7px;
    
    width: 778px;
    height: 554px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 1;

    margin:auto;
}

main {
    box-sizing: border-box;
    
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 16px;
    gap: 20px;
    
    width: 746px;
    
    background: #FFFFFF;
    border: 1px solid rgba(0, 0, 0, 0.09);
    border-radius: 9px;
        
    flex: none;
    order: 0;
    align-self: stretch;
    flex-grow: 1;
}

h1 {
    width: 77px;
    height: 21px;
    
    font-family: 'Arial';
    font-style: normal;
    font-weight: 600;
    font-size: 18px;
    line-height: 21px;
    display: flex;
    align-items: center;
    text-align: center;
    
    color: rgba(51, 51, 51, 0.9);
        
    flex: none;
    order: 0;
    flex-grow: 0;
}

select {
  font-family: 'Arial';
  font-style: normal;
  font-weight: 600;
  font-size: 18px;

  color: rgba(51, 51, 51, 0.9);

  border: none;
  outline: none;
}

select:hover {
    color: #777777;
}

.title {
  font-size: 84px;
}


#article-list {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 16px;
    
    width: 714px;
        
    flex: none;
    order: 3;
    flex-grow: 0;
}

#featured-list {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    padding: 0px;
    gap: 14px;

    width: 730px;

    flex: none;
    order: 0;
    align-self: stretch;
    flex-grow: 0;
}

.article {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;
    
    width: 714px;
    height: 100px;
        
    flex: none;
    order: 0;
    flex-grow: 0;
}

.article-text-box {    
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 8px;
    
    width: 578px;
    height: 90px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.article-text {
    width: 578px;
    height: 42px;
    
    font-family: 'Arial';
    font-style: normal;
    font-weight: 500;
    font-size: 18px;
    line-height: 21px;
    display: flex;
    align-items: center;
    text-decoration: none;
    
    color: #333333;
    
    
    /* Inside auto layout */
    
    flex: none;
    order: 0;
    flex-grow: 0;
}

.article-text:hover {
    color: #777777;
}

.article-meta {    
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;
    
    width: 300px;
    height: 17px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.article-meta-text {
    font-family: 'Arial';
    font-style: normal;
    font-weight: 400;
    font-size: 14px;
    line-height: 17px;
    
    display: flex;
    align-items: center;
    
    color: rgba(51, 51, 51, 0.7);
        
    flex: none;
    order: 0;
    flex-grow: 0;
}

.button-holder {    
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;
    
    width: 200px;
    height: 17px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.thumbnail {
    width: 160px;
    height: 100px;
    
    /* background: url(image.png); */
    border-radius: 6px;
    
    /* Inside auto layout */
    
    flex: none;
    order: 0;
    flex-grow: 0;
}

.featured {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;

    width: 227px;
    height: 173px;

    flex: none;
    order: 0;
    flex-grow: 0;
}

.featured-thumbnail {
    width: 227px;
    height: 115px;

    background: url(image.png);
    border-radius: 6px;

    flex: none;
    order: 0;
    align-self: stretch;
    flex-grow: 0;
}

.featured-textbox {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 6px;

    width: 227px;
    height: 48px;

    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.button {
    border: none;
    color: white;
    padding: 1px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 12px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 6px;
    width: 50px;
    height: 20px;
}

.save-button {background-color: #4CAF50;}
.save-button:hover { background-color: #3e8a40;}
.like-button {background-color: #4287f5;}
.like-button:hover { background-color: #2d77ed;}
.dislike-button {background-color: #ed2d2d;}
.dislike-button:hover { background-color: #c91c1c; }



</style>
</head>

<body>
  <main>
      <h1 id="title">Chronicle</h2>
      <div id="featured-list"></div>
      <br>
      <select id="dateChooser" onchange="filterByDate();">
        <option value="Chrono">Chronological</option>
        <option value="Day">Popular (Day)</option>
        <option value="Week">Popular (Week)</option>
        <option value="Month">Popular (Month)</option>
        <option value="All-time">Popular (All-time)</option>
      </select>
      <div id="article-list"></div>
      <script>

// From urbit/api
function daToDate(st) {
  const dub = function (n) {
    return parseInt(n) < 10 ? "0" + parseInt(n) : n.toString();
  };
  const da = st.split("..");
  const bigEnd = da[0].split(".");
  const lilEnd = da[1].split(".");
  const ds = `${bigEnd[0].slice(1)}-${dub(bigEnd[1])}-${dub(bigEnd[2])}T${dub(
    lilEnd[0]
  )}:${dub(lilEnd[1])}:${dub(lilEnd[2])}Z`;
  return new Date(ds);
}

var urli = 0;
var groupi = 1;
var datei = 2;
var posteri = 3;
var likesi = 4;
var dislikesi = 5;
var likedi = 6;
var dislikedi = 7;
var savedi = 8;
var featuredi = 9;
var indexi = 10;

getState()
    .then((links) => renderPage(links))

async function getState() {
    const response = await fetch('/apps/chronicle/state')
    return response.json()
}

var originalLinks = []
var currentLinks = []
var activeSpace = '/'
async function renderPage(links)
{
    activeSpace = "/~" + links[0].slice(1);
    console.log(activeSpace);  
    links = links[1];
    console.log(links);  

    for(var i = 0; i < links.length; i++)
    {
        links[i][datei] = daToDate(links[i][datei])
        links[i].push(i)
    }

    links.sort(sortByDate);

    originalLinks = links;
    currentLinks = filterLinks(originalLinks, activeSpace);
    displayFeed(currentLinks);
}

function displayFeed(links) {
    const ArticleList = document.getElementById("article-list");
    const FeaturedList = document.getElementById("featured-list");
    const group = activeSpace;

    while (ArticleList.firstChild) {
        ArticleList.removeChild(ArticleList.firstChild);
    }
    while (FeaturedList.firstChild) {
        FeaturedList.removeChild(FeaturedList.firstChild);
    }

    if(group == "/")
        FeaturedList.remove();

    for(var i = 0; i < links.length; i++)
    {
      //much of the code between these two branches is redundant
      if(group != "/" && group != "Saved" && links[i][featuredi] == true)
      {
        const newArticle = document.createElement("div");
            newArticle.classList.add("featured");

            const thumbnail = document.createElement("img");
                thumbnail.classList.add("featured-thumbnail");
                thumbnail.setAttribute('src', "https://news.mit.edu/sites/default/files/images/202010/MIT-Roboat%20II-Close.jpg");
            newArticle.appendChild(thumbnail);

            articleTextBox = createArticleTextBox(links, i);
            newArticle.appendChild(articleTextBox); 

        FeaturedList.appendChild(newArticle);
      }
      else
      {
        const newArticle = document.createElement("div");
            newArticle.classList.add("article");

            const thumbnail = document.createElement("img");
                thumbnail.classList.add("thumbnail");
                //thumbnail.setAttribute('src', links[i][5]);   Thumbnail goes here
                thumbnail.setAttribute('src', "https://news.mit.edu/sites/default/files/images/202010/MIT-Roboat%20II-Close.jpg");
            newArticle.appendChild(thumbnail);

            articleTextBox = createArticleTextBox(links, i);
            newArticle.appendChild(articleTextBox); 

        ArticleList.appendChild(newArticle);
      }
    }
}

function createArticleTextBox(links, i){
    const articleTextBox = document.createElement("div");
    articleTextBox.classList.add("article-text-box");

    const articleText = document.createElement("a");
        articleText.classList.add("article-text");
        //articleText.textContent = links[i][0]; Post title goes here
        articleText.textContent = links[i][0];
        articleText.setAttribute('href', links[i][urli]);

    articleTextBox.appendChild(articleText);

    const articleMeta = document.createElement("div");
        articleMeta.classList.add("article-meta");
        const metaText = document.createElement("div");
            metaText.classList.add("article-meta-text");
            // Site author goes here
            metaText.textContent = links[i][datei].toLocaleDateString() + " - Washington Post - " + links[i][posteri];
        articleMeta.appendChild(metaText);
    
    articleTextBox.appendChild(articleMeta);

    buttonHolder = createButtonHolder(links, i);
    articleTextBox.appendChild(buttonHolder);

    return articleTextBox;
}

function createButtonHolder(links, i){
    const buttonHolder = document.createElement("div")
    buttonHolder.classList.add("article-meta");
    const saveButton = document.createElement("button");
        saveButton.classList.add("button");
        saveButton.classList.add("save-button");
        saveButton.trueIndex = links[i][indexi];
        saveButton.saved = links[i][savedi];
        if(saveButton.saved == 0)
            saveButton.textContent = "Save";
        else
            saveButton.textContent = "Saved";
        saveButton.addEventListener('click', save);
    buttonHolder.appendChild(saveButton);

    buttonHolder.classList.add("button-holder");
    const likeButton = document.createElement("button");
        likeButton.classList.add("button");
        likeButton.classList.add("like-button");
        likeButton.trueIndex = links[i][indexi];
        likeButton.liked = links[i][likedi];
        if(likeButton.liked == 0)
            likeButton.textContent = "Like";
        else
            likeButton.textContent = "Liked";
        likeButton.addEventListener('click', like);
    buttonHolder.appendChild(likeButton);

    buttonHolder.classList.add("article-meta");
    const dislikeButton = document.createElement("button");
        dislikeButton.classList.add("button");
        dislikeButton.classList.add("dislike-button");
        dislikeButton.trueIndex = links[i][indexi];
        dislikeButton.disliked = links[i][dislikedi];
        if(dislikeButton.disliked == 0)
            dislikeButton.textContent = "Dislike";
        else
            dislikeButton.textContent = "Disliked";
        dislikeButton.addEventListener('click', dislike);
    buttonHolder.appendChild(dislikeButton);

    return buttonHolder;
}

function save(){
    var index = event.currentTarget.trueIndex;
    var link;

    for(var i = 0; i < originalLinks.length; i++)
      if(originalLinks[i][indexi] == index)
      {
        link = originalLinks[i];
        index = i;
      }

    if(event.currentTarget.saved == 0)
    {
        event.currentTarget.textContent = "Saved";
        event.currentTarget.saved = 1;
        originalLinks[index][savedi] = true;
    }
    else
    {
        event.currentTarget.textContent = "Save";
        event.currentTarget.saved = 0;
        originalLinks[index][savedi] = false;
    }
}

function like(){
    var index = event.currentTarget.trueIndex;
    var link;

    for(var i = 0; i < originalLinks.length; i++)
      if(originalLinks[i][indexi] == index)
      {
        link = originalLinks[i];
        index = i;
      }

    if(event.currentTarget.liked == 0)
    {
        event.currentTarget.textContent = "Liked";
        event.currentTarget.liked = 1;
        originalLinks[index][likedi] = true;
    }
    else
    {
        event.currentTarget.textContent = "Like";
        event.currentTarget.liked = 0;
        originalLinks[index][likedi] = false;
    }
}

function dislike(){
    var index = event.currentTarget.trueIndex;
    var link;

    for(var i = 0; i < originalLinks.length; i++)
      if(originalLinks[i][indexi] == index)
      {
        link = originalLinks[i];
        index = i;
      }

    if(event.currentTarget.disliked == 0)
    {
        event.currentTarget.textContent = "Disiked";
        event.currentTarget.disliked = 1;
        originalLinks[index][dislikedi] = true;
    }
    else
    {
        event.currentTarget.textContent = "Dislike";
        event.currentTarget.disliked = 0;
        originalLinks[index][dislikedi] = false;
    }
}

function filterLinks(links, group) {
    var newLinks = []

    for(var i = 0; i < links.length; i++)
    {
      if(links[i][groupi] == group || group == "/" || (group == "Saved" && links[i][savedi] == true))
        newLinks.push(links[i])
    }

    return newLinks;
}

function filterByDate() {
    var timeframe = document.getElementById("dateChooser").value;
    var d = new Date;
    
    var dateLinks = [];

    for(var i = 0; i < currentLinks.length; i++)
    {
        if(timeframe == "Chrono" || timeframe == "All-time" || currentLinks[i][featuredi] == true)
            dateLinks.push(currentLinks[i])
        else if(timeframe == "Day")
        {
            if(currentLinks[i][datei] > d - 86400000)
                dateLinks.push(currentLinks[i])
        }
        else if(timeframe == "Week")
        {
            if(currentLinks[i][datei] > d - 604800000)
                dateLinks.push(currentLinks[i])
        }
        else if(timeframe == "Month")
        {
            if(currentLinks[i][datei] > d - 2629800000)
                dateLinks.push(currentLinks[i])
        }
    }

    //if(timeframe == "Chrono")
    //  dateLinks.sort(sortByDate);
    // currentLinks should already be sorted by date, so these will be too

    if(timeframe != "Chrono")
      dateLinks.sort(sortByLikes);

    displayFeed(dateLinks);
}

function sortByDate(a, b) {
    if (a[datei] === b[datei]) {
        return 0;
    }
    else {
        return (a[datei] < b[datei]) ? 1 : -1;
    }
}

function sortByLikes(a, b) {
    if ((a[likesi] - a[dislikesi]) === (b[likesi] - b[dislikesi])) {
        return 0;
    }
    else {
        return ((a[likesi] - a[dislikesi]) < (b[likesi] - b[dislikesi])) ? 1 : -1;
    }
}

      </script>
  </main>
</body>


