<head>
<link href="https://fonts.googleapis.com/css?family=Rubik:300,400,500&display=swap" rel="stylesheet" />
  <style>

html {background-color: var(--rlm-window-color);}

body {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 16px 16px 42px 16px;
    gap: 7px;
    
    width: calc(100% - 16px);
    height: 100vh;

    align-items: center;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 1;

    margin: auto;

    background-color: var(--rlm-window-color);
}

main {
    overflow: auto;

    box-sizing: border-box;
    
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 16px 16px 42px 16px;

    gap: 20px;
    
    width: calc(100% - 16px);
    height: calc(100% - 32px);
    margin-bottom: 16px;
    
    background: #FFFFFF;
    border: 1px solid rgba(0, 0, 0, 0.09);
    border-radius: 9px;
        
    flex: none;
    order: 0;
    align-self: stretch;
    flex-grow: 1;

    background-color: var(--rlm-card-color);
}

h1 {
    width: 500px;
    
    font-family: var(--rlm-font);
    font-style: normal;
    font-weight: 500;
    font-size: 24px;
    
    color: var(--rlm-text-color);

}

select {
  font-family: var(--rlm-font);
  font-style: normal;
  font-weight: 500;
  font-size: 24px;

  color: var(--rlm-text-color);
  background-color: var(--rlm-card-color);

  border: none;
  outline: none;
}

::-webkit-scrollbar {
  width: 0px;
}

/* Track */
::-webkit-scrollbar-track {
  box-shadow: inset 0 0 0px var(--rlm-card-color); 
  border-radius: 0px;
}
 
/* Handle */
::-webkit-scrollbar-thumb {
  background: var(--rlm-card-color); 
  border-radius: 0px;
}

select:hover {
    color: #919191;
}

.title {
  font-size: 120px;
}

#article-list {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 16px;
    
    width: 400px;
        
    flex: none;
    order: 3;
    flex-grow: 0;
}

#featured-list {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    padding: 0px;
    gap: 7px 32px;

    width: 100%;
    flex-wrap: wrap;

    flex: none;
    order: 0;
    align-self: stretch;
    flex-grow: 0;
}

.article {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;
    
    width: 500px;
    height: 100px;
        
    flex: none;
    order: 0;
    flex-grow: 0;
}

.article-text-box {    
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 8px;
    
    width: 200px;
    height: 80px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.article-text {
    width: 500px;
    
    font-family: var(--rlm-font);
    font-style: normal;
    font-weight: 500;
    font-size: 18px;
    align-items: center;
    text-decoration: none;
    
    color: var(--rlm-text-color);

    white-space: nowrap;
    text-overflow: ellipsis;
    display: block;
    overflow: hidden;
}

.featured-text {
    width: 227px;
    
    font-family: var(--rlm-font);
    font-style: normal;
    font-weight: 500;
    font-size: 18px;
    line-height: 21px;
    align-items: center;
    text-decoration: none;
    
    color: var(--rlm-text-color);

    white-space: nowrap;
    text-overflow: ellipsis;
    display: block;
    overflow: hidden
}

.featured-text:hover {
    color: #919191;
}

.article-text:hover {
    color: #919191;
}

.article-meta {    
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;
    
    width: 300px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.article-meta-text {
    font-family: var(--rlm-font);
    font-style: normal;
    font-weight: 400;
    font-size: 14px;

    opacity: .8;
    
    display: flex;
    align-items: center;
    
    color: var(--rlm-text-color);
        
    flex: none;
    order: 0;
    flex-grow: 0;
}

.thumbnail {
    width: 160px;
    height: 100px;
    
    /* background: url(image.png); */
    border-radius: 6px;
    
    /* Inside auto layout */
    
    flex: none;
    order: 0;
    flex-grow: 0;

    object-fit: cover;
}

.featured {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;

    width: 227px;
    height: 226px;

    flex: none;
    order: 0;
    flex-grow: 0;
}

.featured-thumbnail {
    width: 237px;
    height: 130px;

    background: url(image.png);
    border-radius: 6px;

    flex: none;
    order: 0;
    align-self: stretch;
    flex-grow: 0;

    object-fit: cover;
}

.featured-text-box {    
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 8px;
    
    width: 227px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.button-holder {
  display: flex;
  justify-content: space-between;
  width: 100%;
  height: 17px;
}

.button {
  width: 25%;
  height: 20px;

  background-color: var(--rlm-card-color);
  font-size: 8px;
  font-weight: 500;
  border: 1px;
  border-radius: 6px;
  text-align: center;
}
.button:hover {background-color: var(--rlm-accent-color);}

.invisible-button {background-color: #ffffff00; color: #ffffff00}
.invisible-button:hover {background-color: #ffffff00; color: #ffffff00}

</style>
</head>

<body>
  <main>
      <h1 id="featured-header">Featured</h1>
      <div id="featured-list"></div>
      <select id="dateChooser" onchange="filterByDate();">
        <option value="Chrono">Chronological</option>
        <option value="Day">Liked (Day)</option>
        <option value="Week">Liked (Week)</option>
        <option value="Month">Liked (Month)</option>
        <option value="All-time">Liked (All-time)</option>
      </select>
      <div id="article-list"></div>
      <script>

// From urbit/api
function daToDate(st) {
  const dub = function (n) {
    return parseInt(n) < 10 ? "0" + parseInt(n) : n.toString();
  };
  const da = st.split("..");
  const bigEnd = da[0].split(".");
  const lilEnd = da[1].split(".");
  const ds = `${bigEnd[0].slice(1)}-${dub(bigEnd[1])}-${dub(bigEnd[2])}T${dub(
    lilEnd[0]
  )}:${dub(lilEnd[1])}:${dub(lilEnd[2])}Z`;
  return new Date(ds);
}


function postSave(date)
{
    fetch('/apps/chronicle', {
        method: 'POST',
        body: JSON.stringify({'save': date})
    })
}

function postLike(date)
{
    fetch('/apps/chronicle', {
        method: 'POST',
        body: JSON.stringify({'like': date})
    })
}

function postDislike(date)
{
    fetch('/apps/chronicle', {
        method: 'POST',
        body: JSON.stringify({'dislike': date})
    })
}

function postFeature(date)
{
    fetch('/apps/chronicle', {
        method: 'POST',
        body: JSON.stringify({'feature': date})
    })
}

var urli = 0;
var groupi = 1;
var datei = 2;
var posteri = 3;
var likesi = 4;
var dislikesi = 5;
var likedi = 6;
var dislikedi = 7;
var savedi = 8;
var featuredi = 9;
var titlei = 10;
var imgurli = 11
var indexi = 12;
var ogdatei = 13;

getState()
    .then((links) => renderPage(links))


async function getState() {
    const response = await fetch('/apps/chronicle/state')
    return response.json()
}

var defaultThumbnails = [ 
    'https://pbs.twimg.com/media/FjadxrpX0AAAb_w?format=jpg&name=medium',
    'https://pbs.twimg.com/media/FgK6CwhWIAApbWt?format=jpg&name=large',
    'https://pbs.twimg.com/media/FeeigkoXkAQuWhu?format=jpg&name=4096x4096',
    'https://pbs.twimg.com/media/Fa3El9fWAAIcwIC?format=jpg&name=medium',
    'https://pbs.twimg.com/media/FSZv1AHXIAAe_Jn?format=jpg&name=large',
    'https://pbs.twimg.com/media/Fd6pUT3XgAUWPWu?format=jpg&name=medium',
    'https://pbs.twimg.com/media/FiXLyWEXoAACWb1?format=jpg&name=large',
]


var saveButtonSVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" style="fill: var(--rlm-icon-color);"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 2h14a1 1 0 0 1 1 1v19.143a.5.5 0 0 1-.766.424L12 18.03l-7.234 4.536A.5.5 0 0 1 4 22.143V3a1 1 0 0 1 1-1zm13 2H6v15.432l6-3.761 6 3.761V4z"/></svg>';
var saveButtonFillSVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" style="fill: var(--rlm-icon-color);"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 2h14a1 1 0 0 1 1 1v19.143a.5.5 0 0 1-.766.424L12 18.03l-7.234 4.536A.5.5 0 0 1 4 22.143V3a1 1 0 0 1 1-1z"/></svg>'
var likeButtonSVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" style="fill: var(--rlm-icon-color);"><path fill="none" d="M0 0h24v24H0z"/><path d="M14.6 8H21a2 2 0 0 1 2 2v2.104a2 2 0 0 1-.15.762l-3.095 7.515a1 1 0 0 1-.925.619H2a1 1 0 0 1-1-1V10a1 1 0 0 1 1-1h3.482a1 1 0 0 0 .817-.423L11.752.85a.5.5 0 0 1 .632-.159l1.814.907a2.5 2.5 0 0 1 1.305 2.853L14.6 8zM7 10.588V19h11.16L21 12.104V10h-6.4a2 2 0 0 1-1.938-2.493l.903-3.548a.5.5 0 0 0-.261-.571l-.661-.33-4.71 6.672c-.25.354-.57.644-.933.858zM5 11H3v8h2v-8z"/></svg>'
var dislikeButtonSVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" style="fill: var(--rlm-icon-color);"><path fill="none" d="M0 0h24v24H0z"/><path d="M9.4 16H3a2 2 0 0 1-2-2v-2.104a2 2 0 0 1 .15-.762L4.246 3.62A1 1 0 0 1 5.17 3H22a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-3.482a1 1 0 0 0-.817.423l-5.453 7.726a.5.5 0 0 1-.632.159L9.802 22.4a2.5 2.5 0 0 1-1.305-2.853L9.4 16zm7.6-2.588V5H5.84L3 11.896V14h6.4a2 2 0 0 1 1.938 2.493l-.903 3.548a.5.5 0 0 0 .261.571l.661.33 4.71-6.672c.25-.354.57-.644.933-.858zM19 13h2V5h-2v8z"/></svg>'
var featureButtonSVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" style="fill: var(--rlm-icon-color);"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18.26l-7.053 3.948 1.575-7.928L.587 8.792l8.027-.952L12 .5l3.386 7.34 8.027.952-5.935 5.488 1.575 7.928L12 18.26zm0-2.292l4.247 2.377-.949-4.773 3.573-3.305-4.833-.573L12 5.275l-2.038 4.42-4.833.572 3.573 3.305-.949 4.773L12 15.968z"/></svg>'
var featureButtonFillSVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" style="fill: var(--rlm-icon-color)";><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18.26l-7.053 3.948 1.575-7.928L.587 8.792l8.027-.952L12 .5l3.386 7.34 8.027.952-5.935 5.488 1.575 7.928z"/></svg>'

var originalLinks = []
var currentLinks = []
var activeSpace = '/'
var myShip = ''
var spaceHost = ''
var ourSpace = ''
var featuredHeaderText;
async function renderPage(links)
{   
    myShip = links[0];
    ourSpace = "/" + myShip + "/our";
    //activeSpace = "/" + links[1].slice(1);
    activeSpace = links[1];
    spaceHost = activeSpace.split("/")[1];
    links = links[2];

    //const title = document.getElementById("title");
    /*if(activeSpace == ourSpace)
        title.textContent = myShip;
    else
        title.textContent = activeSpace;*/
    //title.textContent = '';

    const featuredHeader = document.getElementById("featured-header");
    if(activeSpace == ourSpace)
        featuredHeaderText = "Saved Links";
    else
        featuredHeaderText = "Featured by " + spaceHost;

    featuredHeader.textContent = featuredHeaderText;

    for(var i = 0; i < links.length; i++)
    {
        links[i].push(0)    //trueIndex - indexi
        links[i].push(links[i][datei])  //original date - ogdatei
        links[i][datei] = daToDate(links[i][datei])    //visually friendly date
        
        if(links[i][imgurli] == '')
            links[i][imgurli] = defaultThumbnails[Math.floor(Math.random()*defaultThumbnails.length)]
    }

    links.sort(sortByDate);

    for(var i = 0; i < links.length; i++)
        links[i][indexi] = i;    //trueIndex - indexi

    originalLinks = links;
    currentLinks = filterLinks(originalLinks, activeSpace);
    displayFeed(currentLinks);
}

function displayFeed(links) {
    const ArticleList = document.getElementById("article-list");
    const FeaturedList = document.getElementById("featured-list");
    const group = activeSpace;

    while (ArticleList.firstChild) {
        ArticleList.removeChild(ArticleList.firstChild);
    }
    while (FeaturedList.firstChild) {
        FeaturedList.removeChild(FeaturedList.firstChild);
    }

    var removeFeatured = 1;

    for(var i = 0; i < links.length; i++)
    {
      //much of the code between these two branches is redundant
      if((group != ourSpace && links[i][featuredi] == true) || (group == ourSpace && links[i][savedi] == true))
      {
        const newArticle = document.createElement("div");
            newArticle.classList.add("featured");

            const thumbnail = document.createElement("img");
                thumbnail.classList.add("featured-thumbnail");
                thumbnail.setAttribute('src', links[i][imgurli]);
            newArticle.appendChild(thumbnail);

            articleTextBox = createArticleTextBox(links, i, 1);
            newArticle.appendChild(articleTextBox); 

        FeaturedList.appendChild(newArticle);

        removeFeatured = 0;
      }
      else
      {
        const newArticle = document.createElement("div");
            newArticle.classList.add("article");

            const thumbnail = document.createElement("img");
                thumbnail.classList.add("thumbnail");
                thumbnail.setAttribute('src', links[i][imgurli]);
            newArticle.appendChild(thumbnail);

            articleTextBox = createArticleTextBox(links, i, 0);
            newArticle.appendChild(articleTextBox); 

        ArticleList.appendChild(newArticle);
      }
    }

    if(removeFeatured == 1)
        document.getElementById("featured-header").textContent = "";
    else
        document.getElementById("featured-header").textContent = featuredHeaderText;

}

function createArticleTextBox(links, i, featured){
    const articleTextBox = document.createElement("div");
    if(featured == 1)
        articleTextBox.classList.add("featured-text-box");
    else
        articleTextBox.classList.add("article-text-box");

    const articleText = document.createElement("a");
        if(featured == 1)
            articleText.classList.add("featured-text");
        else
            articleText.classList.add("article-text");
        articleText.textContent = links[i][titlei];
        articleText.setAttribute('href', links[i][urli]);

    articleTextBox.appendChild(articleText);

    const articleMeta = document.createElement("div");
        articleMeta.classList.add("article-meta");
        const metaText = document.createElement("div");
            metaText.classList.add("article-meta-text");
            // Site author goes here
            metaText.textContent = links[i][datei].toLocaleDateString() + " " + links[i][posteri];
        articleMeta.appendChild(metaText);
    
    articleTextBox.appendChild(articleMeta);

    buttonHolder = createButtonHolder(links, i);
    articleTextBox.appendChild(buttonHolder);

    return articleTextBox;
}

function createButtonHolder(links, i){
    const buttonHolder = document.createElement("div")

    buttonHolder.classList.add("article-meta");
    buttonHolder.classList.add("button-holder");

    if(myShip == spaceHost && activeSpace != ourSpace)
    {
        const featureButton = document.createElement("button");
            featureButton.classList.add("button");
            featureButton.trueIndex = links[i][indexi];
            featureButton.featured = links[i][featuredi];
            if(featureButton.featured == 1)
                featureButton.innerHTML = featureButtonFillSVG;
            else
                featureButton.innerHTML = featureButtonSVG;
            featureButton.addEventListener('click', feature);
        buttonHolder.appendChild(featureButton);
    }


    const saveButton = document.createElement("button");
        saveButton.classList.add("button");
        saveButton.trueIndex = links[i][indexi];
        saveButton.saved = links[i][savedi];
        saveButton.innerHTML = saveButtonSVG;
        if(saveButton.saved == 1)
            saveButton.innerHTML = saveButtonFillSVG;
        else
            saveButton.innerHTML = saveButtonSVG;
        saveButton.addEventListener('click', save);
    buttonHolder.appendChild(saveButton);


    const likeButton = document.createElement("button");
        likeButton.classList.add("button");
        likeButton.classList.add("like-button");

        if(links[i][likedi] == 1 || links[i][dislikedi] == 1)
            likeButton.classList.add("invisible-button");
        else
            likeButton.innerHTML = likeButtonSVG;

        likeButton.trueIndex = links[i][indexi];
        likeButton.liked = links[i][likedi];
        likeButton.addEventListener('click', like);
    buttonHolder.appendChild(likeButton);


    const dislikeButton = document.createElement("button");
        dislikeButton.classList.add("button");
        dislikeButton.classList.add("dislike-button");

        if(links[i][likedi] == 1 || links[i][dislikedi] == 1)
            dislikeButton.classList.add("invisible-button");
        else
            dislikeButton.innerHTML = dislikeButtonSVG;

        dislikeButton.trueIndex = links[i][indexi];
        dislikeButton.disliked = links[i][dislikedi];
        dislikeButton.addEventListener('click', dislike);
    buttonHolder.appendChild(dislikeButton);

    return buttonHolder;
}

function save(){
    var index = event.currentTarget.trueIndex;
    var link;

    for(var i = 0; i < originalLinks.length; i++)
      if(originalLinks[i][indexi] == index)
      {
        link = originalLinks[i];
        index = i;
      }

    postSave(link[ogdatei]);

    if(event.currentTarget.saved == 0)
    {
        event.currentTarget.saved = 1;
        originalLinks[index][savedi] = true;
    }
    else
    {
        event.currentTarget.saved = 0;
        originalLinks[index][savedi] = false;
    }

    currentLinks = filterLinks(originalLinks, activeSpace);
    displayFeed(currentLinks);
}

function like(){
    var index = event.currentTarget.trueIndex;
    var link;

    for(var i = 0; i < originalLinks.length; i++)
      if(originalLinks[i][indexi] == index)
      {
        link = originalLinks[i];
        index = i;
      }

    postLike(link[ogdatei]);

    event.currentTarget.classList.remove("like-button");
    event.currentTarget.classList.add("invisible-button");

    var buttonHolder = this.closest(".button-holder");
    var dislikeButton = buttonHolder.querySelector(".dislike-button");

    dislikeButton.classList.remove("dislike-button");
    dislikeButton.classList.add("invisible-button");

    event.currentTarget.innerHTML = '';
    dislikeButton.innerHTML = '';
  
    event.currentTarget.liked = 1;
    originalLinks[index][likedi] = true;
}

function dislike(){
    var index = event.currentTarget.trueIndex;
    var link;

    for(var i = 0; i < originalLinks.length; i++)
      if(originalLinks[i][indexi] == index)
      {
        link = originalLinks[i];
        index = i;
      }

    postDislike(link[ogdatei]);

    event.currentTarget.classList.remove("dislike-button");
    event.currentTarget.classList.add("invisible-button");

    var buttonHolder = this.closest(".button-holder");
    var likeButton = buttonHolder.querySelector(".like-button");

    likeButton.classList.remove("like-button");
    likeButton.classList.add("invisible-button");

    event.currentTarget.innerHTML = '';
    likeButton.innerHTML = '';

    event.currentTarget.disliked = 1;
    originalLinks[index][dislikedi] = true;
}

function feature(){
    var index = event.currentTarget.trueIndex;
    var link;

    for(var i = 0; i < originalLinks.length; i++)
      if(originalLinks[i][indexi] == index)
      {
        link = originalLinks[i];
        index = i;
      }

    postFeature(link[ogdatei]);

    if(event.currentTarget.featured == 0)
    {
        event.currentTarget.featured = 1;
        originalLinks[index][featuredi] = true;
    }
    else
    {
        event.currentTarget.featured = 0;
        originalLinks[index][featuredi] = false;
    }

    currentLinks = filterLinks(originalLinks, activeSpace);
    displayFeed(currentLinks);
}

function filterLinks(links, group) {
    var newLinks = []

    for(var i = 0; i < links.length; i++)
    {
      if(links[i][groupi] == group || group == ourSpace)
        newLinks.push(links[i])
    }

    return newLinks;
}

function filterByDate() {
    var timeframe = document.getElementById("dateChooser").value;
    var d = new Date;
    
    var dateLinks = [];

    for(var i = 0; i < currentLinks.length; i++)
    {
        if(timeframe == "Chrono" || timeframe == "All-time" || currentLinks[i][featuredi] == true)
            dateLinks.push(currentLinks[i])
        else if(timeframe == "Day")
        {
            if(currentLinks[i][datei] > d - 86400000)
                dateLinks.push(currentLinks[i])
        }
        else if(timeframe == "Week")
        {
            if(currentLinks[i][datei] > d - 604800000)
                dateLinks.push(currentLinks[i])
        }
        else if(timeframe == "Month")
        {
            if(currentLinks[i][datei] > d - 2629800000)
                dateLinks.push(currentLinks[i])
        }
    }

    if(timeframe != "Chrono")
      dateLinks.sort(sortByLikes);

    displayFeed(dateLinks);
}

function sortByDate(a, b) {
    if (a[datei] === b[datei]) {
        return 0;
    }
    else {
        return (a[datei] < b[datei]) ? 1 : -1;
    }
}

function sortByLikes(a, b) {
    if ((a[likesi] - a[dislikesi]) === (b[likesi] - b[dislikesi])) {
        return 0;
    }
    else {
        return ((a[likesi] - a[dislikesi]) < (b[likesi] - b[dislikesi])) ? 1 : -1;
    }
}

      </script>
  </main>
</body>