<head>
  <style>
body {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 4px 16px 16px;
    gap: 7px;
    
    width: 778px;
    height: 554px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 1;

    margin:auto;
}

main {
    box-sizing: border-box;
    
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 16px;
    gap: 20px;
    
    width: 746px;
    height: 534px;
    
    background: #FFFFFF;
    border: 1px solid rgba(0, 0, 0, 0.09);
    border-radius: 9px;
        
    flex: none;
    order: 0;
    align-self: stretch;
    flex-grow: 1;
}

h1 {
    width: 77px;
    height: 21px;
    
    font-family: 'Arial';
    font-style: normal;
    font-weight: 600;
    font-size: 18px;
    line-height: 21px;
    display: flex;
    align-items: center;
    text-align: center;
    
    color: rgba(51, 51, 51, 0.9);
        
    flex: none;
    order: 0;
    flex-grow: 0;
}

select {
  font-family: 'Arial';
  font-style: normal;
  font-weight: 600;
  font-size: 18px;

  color: rgba(51, 51, 51, 0.9);

  border: none;
  outline: none;
}

select:hover {
    color: #777777;
}

.titleSelect {
  font-size: 42px;
}


#article-list {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 16px;
    
    width: 714px;
    height: 158px;
    
    
    /* Inside auto layout */
    
    flex: none;
    order: 3;
    flex-grow: 0;
}

.article {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;
    
    width: 714px;
    height: 71px;
        
    flex: none;
    order: 0;
    flex-grow: 0;
}

.article-text-box {    
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 8px;
    
    width: 578px;
    height: 71px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.article-text {
    width: 578px;
    height: 42px;
    
    font-family: 'Arial';
    font-style: normal;
    font-weight: 500;
    font-size: 18px;
    line-height: 21px;
    display: flex;
    align-items: center;
    text-decoration: none;
    
    color: #333333;
    
    
    /* Inside auto layout */
    
    flex: none;
    order: 0;
    flex-grow: 0;
}

.article-text:hover {
    color: #777777;
}

.article-meta {    
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;
    
    width: 578px;
    height: 17px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.article-meta-text {
    font-family: 'Arial';
    font-style: normal;
    font-weight: 400;
    font-size: 14px;
    line-height: 17px;
    
    display: flex;
    align-items: center;
    
    color: rgba(51, 51, 51, 0.7);
        
    flex: none;
    order: 0;
    flex-grow: 0;
}

.thumbnail {
    width: 126px;
    height: 71px;
    
    /* background: url(image.png); */
    border-radius: 6px;
    
    /* Inside auto layout */
    
    flex: none;
    order: 0;
    flex-grow: 0;
}
</style>
</head>

<body>
  <main>
      <select id="groupChooser" class="titleSelect" onchange="filterByGroup();">
        <option value="All">All Links</option>
        <option value="Saved">Saved Links</option>
      </select>
      <div id="featured-list"></div>
      <select id="dateChooser" onchange="filterByDate();">
        <option value="Chrono">Chronological</option>
        <option value="Day">Popular (Day)</option>
        <option value="Week">Popular (Week)</option>
        <option value="Month">Popular (Month)</option>
        <option value="All-time">Popular (All-time)</option>
      </select>
      <div id="article-list"></div>
      <script>

// From urbit/api
function daToDate(st) {
  const dub = function (n) {
    return parseInt(n) < 10 ? "0" + parseInt(n) : n.toString();
  };
  const da = st.split("..");
  const bigEnd = da[0].split(".");
  const lilEnd = da[1].split(".");
  const ds = `${bigEnd[0].slice(1)}-${dub(bigEnd[1])}-${dub(bigEnd[2])}T${dub(
    lilEnd[0]
  )}:${dub(lilEnd[1])}:${dub(lilEnd[2])}Z`;
  return new Date(ds);
}

var urli = 0;
var groupi = 1;
var datei = 2;
var posteri = 3;
var likesi = 4;
var dislikesi = 5;
var likedi = 6;
var dislikedi = 7;
var savedi = 8;
var featuredi = 9;

getState()
    .then((links) => renderPage(links))

async function getState() {
    const response = await fetch('/apps/chronicle/state')
    return response.json()
}

var originalLinks = []
var currentLinks = []
async function renderPage(links)
{
    for(var i = 0; i < links.length; i++)
        links[i][datei] = daToDate(links[i][datei])

    links.sort(sortByDate);

    originalLinks = links;
    currentLinks = links;
    fillGroupChooser(links);
    displayFeed(links);
}

function fillGroupChooser(links) {
    var chooser = document.getElementById("groupChooser")
    var groups = []

    for(var i = 0; i < links.length; i++)
    {
        if(!groups.includes(links[i][groupi]))
        {
            groups.push(links[i][groupi])

            const newOption = document.createElement("option");
            newOption.text = links[i][groupi]
            newOption.value = links[i][groupi]
            chooser.appendChild(newOption)
        }
    }
}

function displayFeed(links) {
    const ArticleList = document.getElementById("article-list");
    const FeaturedList = document.getElementById("featured-list");
    const group = document.getElementById("groupChooser").value;

    while (ArticleList.firstChild) {
        ArticleList.removeChild(ArticleList.firstChild);
    }
    while (FeaturedList.firstChild) {
        FeaturedList.removeChild(FeaturedList.firstChild);
    }

    for(var i = 0; i < links.length; i++)
    {
        const newArticle = document.createElement("div");
        newArticle.classList.add("article");

        const articleTextBox = document.createElement("div");
        articleTextBox.classList.add("article-text-box");
        
        const articleText = document.createElement("a");
        articleText.classList.add("article-text");
        //articleText.textContent = links[i][0]; Post title goes here
        articleText.textContent = links[i][0];
        articleText.setAttribute('href', links[i][urli]);

        const articleMeta = document.createElement("div");
        articleMeta.classList.add("article-meta");


        const date = document.createElement("div");
        date.classList.add("article-meta-text");
        date.textContent = links[i][datei].toLocaleDateString();;
        articleMeta.appendChild(date);
        
        const author = document.createElement("div");
        author.classList.add("article-meta-text");
        //author.textContent = links[i][posteri]; Site name goes here
        author.textContent = "Washington Post"
        articleMeta.appendChild(author);

        const poster = document.createElement("div");
        poster.classList.add("article-meta-text");
        poster.textContent = links[i][posteri];
        articleMeta.appendChild(poster);

        const thumbnail = document.createElement("img");
        thumbnail.classList.add("thumbnail");
        //thumbnail.setAttribute('src', links[i][5]);   Thumbnail goes here
        thumbnail.setAttribute('src', "https://news.mit.edu/sites/default/files/images/202010/MIT-Roboat%20II-Close.jpg");
        
        newArticle.appendChild(thumbnail);

        articleTextBox.appendChild(articleText);
        articleTextBox.appendChild(articleMeta);
        
        newArticle.appendChild(articleTextBox); 
        
        if(group != "All" && group != "Saved" && links[i][featuredi] == true)
          FeaturedList.appendChild(newArticle);
        else
          ArticleList.appendChild(newArticle);
    }
}

function filterByGroup() {
    var group = document.getElementById("groupChooser").value;
    currentLinks = filterLinks(originalLinks, group);
    displayFeed(currentLinks);
}

function filterLinks(links, group) {
    var newLinks = []

    for(var i = 0; i < links.length; i++)
    {
      if(links[i][groupi] == group || group == "All" || (group == "Saved" && links[i][savedi] == true))
        newLinks.push(links[i])
    }

    return newLinks;
}

function filterByDate() {
    var timeframe = document.getElementById("dateChooser").value;
    var d = new Date;
    
    var dateLinks = [];

    for(var i = 0; i < currentLinks.length; i++)
    {
        if(timeframe == "Chrono" || timeframe == "All-time" || currentLinks[i][featuredi] == true)
            dateLinks.push(currentLinks[i])
        else if(timeframe == "Day")
        {
            if(currentLinks[i][datei] > d - 86400000)
                dateLinks.push(currentLinks[i])
        }
        else if(timeframe == "Week")
        {
            if(currentLinks[i][datei] > d - 604800000)
                dateLinks.push(currentLinks[i])
        }
        else if(timeframe == "Month")
        {
            if(currentLinks[i][datei] > d - 2629800000)
                dateLinks.push(currentLinks[i])
        }
    }

    //if(timeframe == "Chrono")
    //  dateLinks.sort(sortByDate);
    // currentLinks should already be sorted by date, so these will be too

    if(timeframe != "Chrono")
      dateLinks.sort(sortByLikes);

    displayFeed(dateLinks);
}

function sortByDate(a, b) {
    if (a[datei] === b[datei]) {
        return 0;
    }
    else {
        return (a[datei] < b[datei]) ? 1 : -1;
    }
}

function sortByLikes(a, b) {
    if ((a[likesi] - a[dislikesi]) === (b[likesi] - b[dislikesi])) {
        return 0;
    }
    else {
        return ((a[likesi] - a[dislikesi]) < (b[likesi] - b[dislikesi])) ? 1 : -1;
    }
}

      </script>
  </main>
</body>


