<head>
  <style>
body {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 4px 16px 16px;
    gap: 7px;
    
    width: 778px;
    height: 554px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 1;

    margin:auto;
}

main {
    box-sizing: border-box;
    
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 16px;
    gap: 20px;
    
    width: 746px;
    
    background: #FFFFFF;
    border: 1px solid rgba(0, 0, 0, 0.09);
    border-radius: 9px;
        
    flex: none;
    order: 0;
    align-self: stretch;
    flex-grow: 1;
}

h1 {
    width: 500px;
    height: 21px;
    
    font-family: 'Arial';
    font-style: normal;
    font-weight: 600;
    font-size: 18px;
    line-height: 21px;
    display: flex;
    align-items: left;
    text-align: left;
    
    color: rgba(51, 51, 51, 0.9);
        
    flex: none;
    order: 0;
    flex-grow: 0;
}

select {
  font-family: 'Arial';
  font-style: normal;
  font-weight: 600;
  font-size: 18px;

  color: rgba(51, 51, 51, 0.9);

  border: none;
  outline: none;
}

select:hover {
    color: #777777;
}

.title {
  font-size: 120px;
}

.featured-header {
  font-size: 84px;
}

#article-list {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 16px;
    
    width: 714px;
        
    flex: none;
    order: 3;
    flex-grow: 0;
}

#featured-list {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    padding: 0px;
    gap: 14px;

    width: 730px;
    flex-wrap: wrap;

    flex: none;
    order: 0;
    align-self: stretch;
    flex-grow: 0;
}

.article {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;
    
    width: 714px;
    height: 100px;
        
    flex: none;
    order: 0;
    flex-grow: 0;
}

.article-text-box {    
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 8px;
    
    width: 200px;
    height: 90px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.article-text {
    width: 578px;
    height: 42px;
    
    font-family: 'Arial';
    font-style: normal;
    font-weight: 500;
    font-size: 18px;
    line-height: 21px;
    display: flex;
    align-items: center;
    text-decoration: none;
    
    color: #333333;
    
    /* Inside auto layout */
    
    flex: none;
    order: 0;
    flex-grow: 0;
}

.article-text:hover {
    color: #777777;
}

.article-meta {    
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;
    
    width: 300px;
    height: 17px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.article-meta-text {
    font-family: 'Arial';
    font-style: normal;
    font-weight: 400;
    font-size: 14px;
    line-height: 17px;
    
    display: flex;
    align-items: center;
    
    color: rgba(51, 51, 51, 0.7);
        
    flex: none;
    order: 0;
    flex-grow: 0;
}

.button-holder {    
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;
    
    width: 200px;
    height: 17px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.thumbnail {
    width: 160px;
    height: 100px;
    
    /* background: url(image.png); */
    border-radius: 6px;
    
    /* Inside auto layout */
    
    flex: none;
    order: 0;
    flex-grow: 0;
}

.featured {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 10px;

    width: 227px;
    height: 226px;

    flex: none;
    order: 0;
    flex-grow: 0;
}

.featured-thumbnail {
    width: 227px;
    height: 115px;

    background: url(image.png);
    border-radius: 6px;

    flex: none;
    order: 0;
    align-self: stretch;
    flex-grow: 0;
}

.featured-text-box {    
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 8px;
    
    width: 227px;
    height: 90px;
        
    flex: none;
    order: 1;
    align-self: stretch;
    flex-grow: 0;
}

.button {
    border: none;
    color: white;
    padding: 1px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 12px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 6px;
    width: 50px;
    height: 20px;
}

.save-button {background-color: #4CAF50;}
.save-button:hover { background-color: #3e8a40;}
.like-button {background-color: #4287f5;}
.like-button:hover { background-color: #2d77ed;}
.dislike-button {background-color: #ed2d2d;}
.dislike-button:hover { background-color: #c91c1c; }
.feature-button {background-color: #a40097;}
.feature-button:hover { background-color: #810076; }


</style>
</head>

<body>
  <main>
      <h1 id="title">Chronicle</h1>
      <h1 id="featured-header">Featured</h2>
      <div id="featured-list"></div>
      <select id="dateChooser" onchange="filterByDate();">
        <option value="Chrono">Chronological</option>
        <option value="Day">Popular (Day)</option>
        <option value="Week">Popular (Week)</option>
        <option value="Month">Popular (Month)</option>
        <option value="All-time">Popular (All-time)</option>
      </select>
      <div id="article-list"></div>
      <script>

// From urbit/api
function daToDate(st) {
  const dub = function (n) {
    return parseInt(n) < 10 ? "0" + parseInt(n) : n.toString();
  };
  const da = st.split("..");
  const bigEnd = da[0].split(".");
  const lilEnd = da[1].split(".");
  const ds = `${bigEnd[0].slice(1)}-${dub(bigEnd[1])}-${dub(bigEnd[2])}T${dub(
    lilEnd[0]
  )}:${dub(lilEnd[1])}:${dub(lilEnd[2])}Z`;
  return new Date(ds);
}

function post(tag, data) {
    fetch('/apps/chronicle', {
        method: 'POST',
        body: JSON.stringify({[tag]: data})
    })
    location.reload()
}

const blessing = document.getElementById("blessing");
const interrogate = document.getElementById("interrogate");

function postSave(date)
{
    fetch('/apps/chronicle', {
        method: 'POST',
        body: JSON.stringify({'save': date})
    })
}

function postLike(date)
{
    fetch('/apps/chronicle', {
        method: 'POST',
        body: JSON.stringify({'like': date})
    })
}

function postDislike(date)
{
    fetch('/apps/chronicle', {
        method: 'POST',
        body: JSON.stringify({'dislike': date})
    })
}

function postFeature(date)
{
    fetch('/apps/chronicle', {
        method: 'POST',
        body: JSON.stringify({'feature': date})
    })
}

var urli = 0;
var groupi = 1;
var datei = 2;
var posteri = 3;
var likesi = 4;
var dislikesi = 5;
var likedi = 6;
var dislikedi = 7;
var savedi = 8;
var featuredi = 9;
var titlei = 10;
var imgurli = 11
var indexi = 12;
var ogdatei = 13;

getState()
    .then((links) => renderPage(links))


async function getState() {
    const response = await fetch('/apps/chronicle/state')
    return response.json()
}

var originalLinks = []
var currentLinks = []
var activeSpace = '/'
var myShip = ''
var spaceHost = ''
async function renderPage(links)
{   
    myShip = links[0];
    activeSpace = "/" + links[1].slice(1);
    spaceHost = activeSpace.split("/")[1];
    links = links[2];

    const title = document.getElementById("title");
    if(activeSpace == "/")
        title.textContent = myShip;
    else
        title.textContent = activeSpace;

    const featuredHeader = document.getElementById("featured-header");
    if(activeSpace == "/")
        featuredHeader.textContent = "Saved Links";
    else
    featuredHeader.textContent = "Featured Links";

    for(var i = 0; i < links.length; i++)
    {
        links[i].push(i)    //trueIndex
        links[i].push(links[i][datei])  //original date
        links[i][datei] = daToDate(links[i][datei])    //visually friendly date
    }

    links.sort(sortByDate);

    originalLinks = links;
    currentLinks = filterLinks(originalLinks, activeSpace);
    displayFeed(currentLinks);
}

function displayFeed(links) {
    const ArticleList = document.getElementById("article-list");
    const FeaturedList = document.getElementById("featured-list");
    const group = activeSpace;

    while (ArticleList.firstChild) {
        ArticleList.removeChild(ArticleList.firstChild);
    }
    while (FeaturedList.firstChild) {
        FeaturedList.removeChild(FeaturedList.firstChild);
    }

    var removeFeatured = 1;

    for(var i = 0; i < links.length; i++)
    {
      //much of the code between these two branches is redundant
      if((group != "/" && links[i][featuredi] == true) || (group == "/" && links[i][savedi] == true))
      {
        const newArticle = document.createElement("div");
            newArticle.classList.add("featured");

            const thumbnail = document.createElement("img");
                thumbnail.classList.add("featured-thumbnail");
                if(links[i][imgurli] != '')
                    thumbnail.setAttribute('src', links[i][imgurli]);
                else
                    thumbnail.setAttribute('src', "https://pbs.twimg.com/media/FiXLyWEXoAACWb1?format=jpg&name=large");
            newArticle.appendChild(thumbnail);

            articleTextBox = createArticleTextBox(links, i, 1);
            newArticle.appendChild(articleTextBox); 

        FeaturedList.appendChild(newArticle);

        removeFeatured = 0;
      }
      else
      {
        const newArticle = document.createElement("div");
            newArticle.classList.add("article");

            const thumbnail = document.createElement("img");
                thumbnail.classList.add("thumbnail");
                if(links[i][imgurli] != '')
                    thumbnail.setAttribute('src', links[i][imgurli]);
                else
                    thumbnail.setAttribute('src', "https://pbs.twimg.com/media/FiXLyWEXoAACWb1?format=jpg&name=large");
            newArticle.appendChild(thumbnail);

            articleTextBox = createArticleTextBox(links, i, 0);
            newArticle.appendChild(articleTextBox); 

        ArticleList.appendChild(newArticle);
      }
    }

    if(removeFeatured == 1)
    {
        FeaturedList.remove();
        document.getElementById("featured-header").remove();
    }
}

function createArticleTextBox(links, i, featured){
    const articleTextBox = document.createElement("div");
    if(featured == 1)
        articleTextBox.classList.add("featured-text-box");
    else
        articleTextBox.classList.add("article-text-box");

    const articleText = document.createElement("a");
        articleText.classList.add("article-text");
        articleText.textContent = links[i][titlei];
        articleText.setAttribute('href', links[i][urli]);

    articleTextBox.appendChild(articleText);

    const articleMeta = document.createElement("div");
        articleMeta.classList.add("article-meta");
        const metaText = document.createElement("div");
            metaText.classList.add("article-meta-text");
            // Site author goes here
            metaText.textContent = links[i][datei].toLocaleDateString() + " " + links[i][posteri];
        articleMeta.appendChild(metaText);
    
    articleTextBox.appendChild(articleMeta);

    buttonHolder = createButtonHolder(links, i);
    articleTextBox.appendChild(buttonHolder);

    return articleTextBox;
}

function createButtonHolder(links, i){
    const buttonHolder = document.createElement("div")
    buttonHolder.classList.add("article-meta");
    const saveButton = document.createElement("button");
        saveButton.classList.add("button");
        saveButton.classList.add("save-button");
        saveButton.trueIndex = links[i][indexi];
        saveButton.saved = links[i][savedi];
        if(saveButton.saved == 0)
            saveButton.textContent = "Save";
        else
            saveButton.textContent = "Saved";
        saveButton.addEventListener('click', save);
    buttonHolder.appendChild(saveButton);

    buttonHolder.classList.add("button-holder");
    const likeButton = document.createElement("button");
        likeButton.classList.add("button");
        likeButton.classList.add("like-button");
        likeButton.trueIndex = links[i][indexi];
        likeButton.liked = links[i][likedi];
        if(likeButton.liked == 0)
            likeButton.textContent = "Like (" + links[i][likesi] + ")";
        else
            likeButton.textContent = "Liked (" + links[i][likesi] + ")";
        likeButton.addEventListener('click', like);
    buttonHolder.appendChild(likeButton);

    buttonHolder.classList.add("article-meta");
    const dislikeButton = document.createElement("button");
        dislikeButton.classList.add("button");
        dislikeButton.classList.add("dislike-button");
        dislikeButton.trueIndex = links[i][indexi];
        dislikeButton.disliked = links[i][dislikedi];
        if(dislikeButton.disliked == 0)
            dislikeButton.textContent = "Dislike (" + links[i][dislikesi] + ")";
        else
            dislikeButton.textContent = "Disliked (" + links[i][dislikesi] + ")";
        dislikeButton.addEventListener('click', dislike);
    buttonHolder.appendChild(dislikeButton);

    if(myShip == spaceHost)
    {
        buttonHolder.classList.add("article-meta");
        const featureButton = document.createElement("button");
            featureButton.classList.add("button");
            featureButton.classList.add("feature-button");
            featureButton.trueIndex = links[i][indexi];
            featureButton.featured = links[i][featuredi];
            if(featureButton.featured == 0)
                featureButton.textContent = "Feature";
            else
                featureButton.textContent = "Featured";
            featureButton.addEventListener('click', feature);
        buttonHolder.appendChild(featureButton);
    }

    return buttonHolder;
}

function save(){
    var index = event.currentTarget.trueIndex;
    var link;

    for(var i = 0; i < originalLinks.length; i++)
      if(originalLinks[i][indexi] == index)
      {
        link = originalLinks[i];
        index = i;
      }

    postSave(link[ogdatei]);

    if(event.currentTarget.saved == 0)
    {
        event.currentTarget.textContent = "Saved";
        event.currentTarget.saved = 1;
        originalLinks[index][savedi] = true;
    }
    else
    {
        event.currentTarget.textContent = "Save";
        event.currentTarget.saved = 0;
        originalLinks[index][savedi] = false;
    }
}

function like(){
    var index = event.currentTarget.trueIndex;
    var link;

    for(var i = 0; i < originalLinks.length; i++)
      if(originalLinks[i][indexi] == index)
      {
        link = originalLinks[i];
        index = i;
      }

    postLike(link[ogdatei]);

    event.currentTarget.textContent = "Liked";
    event.currentTarget.liked = 1;
    originalLinks[index][likedi] = true;
}

function dislike(){
    var index = event.currentTarget.trueIndex;
    var link;

    for(var i = 0; i < originalLinks.length; i++)
      if(originalLinks[i][indexi] == index)
      {
        link = originalLinks[i];
        index = i;
      }

    postDislike(link[ogdatei]);

    event.currentTarget.textContent = "Disliked";
    event.currentTarget.disliked = 1;
    originalLinks[index][dislikedi] = true;
}

function feature(){
    var index = event.currentTarget.trueIndex;
    var link;

    for(var i = 0; i < originalLinks.length; i++)
      if(originalLinks[i][indexi] == index)
      {
        link = originalLinks[i];
        index = i;
      }

    postFeature(link[ogdatei]);

    if(event.currentTarget.featured == 0)
    {
        event.currentTarget.textContent = "Featured";
        event.currentTarget.featured = 1;
        originalLinks[index][featured] = true;
    }
    else
    {
        event.currentTarget.textContent = "Feature";
        event.currentTarget.featured = 0;
        originalLinks[index][featured] = false;
    }
}

function filterLinks(links, group) {
    var newLinks = []

    for(var i = 0; i < links.length; i++)
    {
      if(links[i][groupi] == group || group == "/")
        newLinks.push(links[i])
    }

    return newLinks;
}

function filterByDate() {
    var timeframe = document.getElementById("dateChooser").value;
    var d = new Date;
    
    var dateLinks = [];

    for(var i = 0; i < currentLinks.length; i++)
    {
        if(timeframe == "Chrono" || timeframe == "All-time" || currentLinks[i][featuredi] == true)
            dateLinks.push(currentLinks[i])
        else if(timeframe == "Day")
        {
            if(currentLinks[i][datei] > d - 86400000)
                dateLinks.push(currentLinks[i])
        }
        else if(timeframe == "Week")
        {
            if(currentLinks[i][datei] > d - 604800000)
                dateLinks.push(currentLinks[i])
        }
        else if(timeframe == "Month")
        {
            if(currentLinks[i][datei] > d - 2629800000)
                dateLinks.push(currentLinks[i])
        }
    }

    //if(timeframe == "Chrono")
    //  dateLinks.sort(sortByDate);
    // currentLinks should already be sorted by date, so these will be too

    if(timeframe != "Chrono")
      dateLinks.sort(sortByLikes);

    displayFeed(dateLinks);
}

function sortByDate(a, b) {
    if (a[datei] === b[datei]) {
        return 0;
    }
    else {
        return (a[datei] < b[datei]) ? 1 : -1;
    }
}

function sortByLikes(a, b) {
    if ((a[likesi] - a[dislikesi]) === (b[likesi] - b[dislikesi])) {
        return 0;
    }
    else {
        return ((a[likesi] - a[dislikesi]) < (b[likesi] - b[dislikesi])) ? 1 : -1;
    }
}

      </script>
  </main>
</body>


